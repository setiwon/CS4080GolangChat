<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <style>
        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 8px;
        }
        .message-label {
            font-size: 0.8rem;
            /* font-weight: bold; */
            margin-right: 10px;
            margin-top: 0.75rem;
        }
        textarea {
            resize: none;
        }
        .container {
            padding-top: 32px;
            max-width: 700px;
        }

    </style>

</head>
<body>

<main>
  <div class="container">
      <div id="messages" class="d-flex flex-column"></div>
      <form id="chatbox" class="mt-3" enctype="multipart/form-data">
          <div class="input-group mb-3">
              <input id="chat-input" class="form-control" placeholder="send message" autofocus required autocomplete="off" aria-label="send message" aria-describedby="send-button"></textarea>
              <button class="btn btn-outline-primary" type="submit" id="send-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                  <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
                </svg>
              </button>
              <input type="file" id="file-input" class="form-control" style="display: none;" />
              <button class="btn btn-outline-primary" type="button" id="upload-button">
                Upload File
              </button>
          </div>
      </form>
  </div>
</main>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script>

    $(function(){
        var socket = null;
        var name = "";
        var msgBox = $("#chatbox input");
        var messages = $("#messages");

        $("#chatbox").submit(function(){

          if (!msgBox.val()) return false;
          if (!socket) {
            alert("Error: There is no socket connection.");
            return false;
          }

          socket.send(JSON.stringify({ method: "message", body: msgBox.val() }));
          msgBox.val("");
          return false;

        });

        $("#upload-button").click(function() {
          $("#file-input").click();
        });

        $("#file-input").change(function() {
          // Handle file upload here
          var file = $(this).prop("files")[0];
          // You can send this file via WebSocket
          console.log("File selected:", file);
        });

        if (!window["WebSocket"]) {
          alert("Error: Your browser does not support web sockets.")
        } else {
          name = prompt("Please enter your name")
          socket = new WebSocket("ws://{{.Host}}/room");
          socket.onopen = function () {
            socket.send(JSON.stringify({ method: "name", body: name }))
          }
          socket.onclose = function() {
            alert("Connection has been closed.");
          }
          socket.onmessage = function(e) {
            let data = JSON.parse(e.data);
            if (data.sender === name) {
              // no longer vulnerable to XSS!
              messages.append(`
              <div class="d-flex justify-content-end">
                <div class="message-bubble bg-primary text-white">${data.message}</li>
              </div>
              `);
            } else {
              messages.append(`
              <div class="d-flex justify-content-start">
                <div class="message-label">${data.sender}</div>
                <div class="message-bubble bg-light text-dark">${data.message}</li>
              </div>
              `);
            }
          }
        }

      });

    </script>
  </body>
</html>